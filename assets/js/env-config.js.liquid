---
---
/**
 * Environment Configuration Handler
 * Securely loads API credentials from environment variables or secure sources
 */
class EnvironmentConfig {
    constructor() {
        this.config = {};
        this.initialized = false;
    }

    /**
     * Initialize configuration from various secure sources
     */
    async initialize() {
        // Skip Netlify function for local development (Jekyll can't serve functions)
        const isLocalDevelopment = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
        
        console.log('üîß Environment Config: Detecting environment...');
        console.log(`   ‚Ä¢ Hostname: ${window.location.hostname}`);
        console.log(`   ‚Ä¢ Is Local Development: ${isLocalDevelopment}`);
        
        if (!isLocalDevelopment) {
            console.log('üåê Production environment - trying Netlify function...');
            try {
                // Method 1: Try to load from Netlify Functions (most secure for production)
                await this.loadFromNetlifyFunction();
                this.initialized = true;
                console.log('‚úÖ Environment configuration initialized from Netlify function');
                return;
            } catch (error) {
                console.warn('‚ùå Failed to load from Netlify function:', error.message);
            }
        } else {
            console.log('üè† Local development detected - skipping Netlify function');
        }
        
        try {
            // Method 2: Try Jekyll/site configuration as fallback
            await this.loadFromSiteConfig();
        } catch (siteError) {
            console.warn('Failed to load from site config:', siteError.message);
            
            // Method 3: Final fallback to environment variables (for local development)
            this.loadFromEnvironment();
        }
        
        this.initialized = true;
        console.log('Environment configuration initialized');
    }

    /**
     * Load configuration from Netlify Functions (secure for production)
     */
    async loadFromNetlifyFunction() {
        try {
            // Try to get Auth0 token for authenticated request
            let headers = {};
            if (window.authService && window.authService.client && window.authService.isAuthenticated) {
                try {
                    const token = await window.authService.client.getTokenSilently();
                    headers['Authorization'] = `Bearer ${token}`;
                } catch (tokenError) {
                    console.warn('Could not get Auth0 token for API request:', tokenError);
                }
            }
            
            const response = await fetch('/.netlify/functions/get-api-key', { headers });
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            this.config = {
                googleDrive: {
                    client_id: data.googleDriveClientId,
                    api_key: data.googleDriveApiKey
                },
                auth0: {
                    domain: data.auth0Domain,
                    client_id: data.auth0ClientId,
                    audience: data.auth0Audience
                },
                spotify: {
                    client_id: data.spotifyClientId
                },
                appleMusic: {
                    developer_token: data.appleMusicDeveloperToken,
                    team_id: data.appleMusicTeamId || '5S855HB895',
                    key_id: data.appleMusicKeyId || 'F9Q8YRKX3T',
                    private_key: data.appleMusicPrivateKey
                }
            };
            
            console.log('Configuration loaded from Netlify function');
        } catch (error) {
            throw new Error(`Failed to load from Netlify function: ${error.message}`);
        }
    }

    /**
     * Load configuration from Jekyll site config (fallback method)
     */
    async loadFromSiteConfig() {
        // This uses hardcoded values as a temporary fallback
        // In production, this should be replaced with environment variables
        this.config = {
            googleDrive: {
                client_id: '53684428529-27609a7n7fd3rtov2a86vrq1gvffs62t.apps.googleusercontent.com',
                api_key: 'AIzaSyBeYgUCi017eGe7Gt1_aSbNXn96LgcE18o'
            },
            auth0: {
                domain: 'dev-l57dcpkhob0u7ykb.us.auth0.com',
                client_id: 'ql8ttR4YSmZXZbGE30wP8foWCUuZs2jh',
                audience: 'https://carsontkempf.github.io/api/carsons-meditations'
            },
            spotify: {
                client_id: '80826ef3daa547f49d843c254ad224b6'
            },
            appleMusic: {
                developer_token: '{{ site.data.apple_music_token.developer_token | default: "" }}',
                team_id: '5S855HB895',
                key_id: 'F9Q8YRKX3T',
                private_key: '{{ site.data.apple_music_token.private_key | default: "" }}'
            }
        };
        
        console.log('‚úÖ Configuration loaded from Jekyll site config');
        console.log('üéµ Apple Music token loaded:', !!this.config.appleMusic?.developer_token);
    }

    /**
     * Load from environment variables (for local development)
     */
    loadFromEnvironment() {
        // For Jekyll sites, environment variables need to be passed differently
        // This is a fallback method for local development
        this.config = {
            googleDrive: {
                client_id: process.env.GOOGLE_DRIVE_CLIENT_ID || '',
                api_key: process.env.GOOGLE_DRIVE_API_KEY || ''
            },
            auth0: {
                domain: process.env.AUTH0_DOMAIN || '',
                client_id: process.env.AUTH0_CLIENT_ID || '',
                audience: process.env.AUTH0_AUDIENCE_SERVER || ''
            },
            spotify: {
                client_id: process.env.SPOTIFY_CLIENT_ID || ''
            },
            appleMusic: {
                developer_token: process.env.APPLE_MUSIC_DEVELOPER_TOKEN || '',
                team_id: process.env.APPLE_TEAM_ID || '5S855HB895',
                key_id: process.env.APPLE_KEY_ID || 'F9Q8YRKX3T',
                private_key: process.env.APPLE_PRIVATE_KEY || ''
            }
        };
        
        console.log('Configuration loaded from environment variables');
    }

    /**
     * Get Google Drive configuration
     */
    getGoogleDriveConfig() {
        if (!this.initialized) {
            throw new Error('Configuration not initialized. Call initialize() first.');
        }
        
        const config = this.config.googleDrive;
        if (!config.client_id || !config.api_key) {
            throw new Error('Google Drive API credentials not found in configuration');
        }
        
        return {
            client_id: config.client_id,
            api_key: config.api_key,
            scopes: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.email'
        };
    }

    /**
     * Get Auth0 configuration
     */
    getAuth0Config() {
        if (!this.initialized) {
            throw new Error('Configuration not initialized. Call initialize() first.');
        }
        
        return this.config.auth0;
    }

    /**
     * Get Spotify configuration
     */
    getSpotifyConfig() {
        if (!this.initialized) {
            throw new Error('Configuration not initialized. Call initialize() first.');
        }
        
        const config = this.config.spotify;
        if (!config.client_id) {
            throw new Error('Spotify client ID not found in configuration');
        }
        
        return config;
    }

    /**
     * Get Apple Music configuration
     */
    getAppleMusicConfig() {
        if (!this.initialized) {
            throw new Error('Configuration not initialized. Call initialize() first.');
        }
        
        const config = this.config.appleMusic;
        
        // Return full config including credentials for JWT generation
        return {
            developer_token: config.developer_token || null,
            team_id: config.team_id || '5S855HB895',
            key_id: config.key_id || 'F9Q8YRKX3T',
            private_key: config.private_key || null,
            canGenerateToken: !!(config.team_id && config.key_id && config.private_key)
        };
    }

    /**
     * Check if configuration is ready
     */
    isReady() {
        return this.initialized && 
               this.config.googleDrive?.client_id && 
               this.config.googleDrive?.api_key &&
               this.config.auth0?.client_id &&
               this.config.spotify?.client_id;
    }
}

// Create global instance
window.envConfig = new EnvironmentConfig();

// Initialize on page load
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üîß Environment Config: Starting initialization...');
    try {
        await window.envConfig.initialize();
        
        // Set global Google Drive config for compatibility
        window.googleDriveConfig = window.envConfig.getGoogleDriveConfig();
        
        console.log('‚úÖ Environment Config: Complete');
        console.log('üìä Config loaded:', {
            Apple: !!window.envConfig.config?.appleMusic?.developer_token,
            Spotify: !!window.envConfig.config?.spotify?.client_id,
            GoogleDrive: !!window.envConfig.config?.googleDrive?.client_id
        });
        
        // Dispatch event when config is ready
        window.dispatchEvent(new CustomEvent('configReady', {
            detail: { envConfig: window.envConfig }
        }));
    } catch (error) {
        console.error('‚ùå Failed to initialize environment configuration:', error);
        
        // Dispatch error event
        window.dispatchEvent(new CustomEvent('configError', {
            detail: { error: error.message }
        }));
    }
});