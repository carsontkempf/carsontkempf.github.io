<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Music API Integration Test</title>
    <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        input, button, select {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background-color: #007AFF;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        button:hover { background-color: #0056CC; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .search-result {
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #fafafa;
        }
        
        .song-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .song-artwork {
            width: 60px;
            height: 60px;
            border-radius: 5px;
        }
        
        .song-details h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .song-details p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .add-button {
            margin-left: auto;
            background-color: #FF3B30;
        }
        
        .add-button:hover {
            background-color: #D70015;
        }

        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üçé Apple Music API Integration Test</h1>
    <p>This page tests the complete Apple Music integration: authorization, search, and library management.</p>

    <!-- Step 1: Authorization -->
    <div class="section">
        <h2>Step 1: Apple Music Authorization</h2>
        <p>Click "Authorize" to request permission to access your Apple Music library.</p>
        <button id="authorize-btn">Authorize Apple Music</button>
        <button id="unauthorize-btn" style="display:none;">Sign Out</button>
        <div id="auth-status" class="status info">Not authorized</div>
    </div>

    <!-- Step 2: Search -->
    <div class="section">
        <h2>Step 2: Search Apple Music</h2>
        <div>
            <input type="text" id="search-input" placeholder="Enter song or artist name" style="width: 300px;">
            <select id="search-type">
                <option value="songs">Songs</option>
                <option value="albums">Albums</option>
                <option value="artists">Artists</option>
                <option value="playlists">Playlists</option>
            </select>
            <button id="search-btn">Search</button>
        </div>
        <div id="search-status"></div>
        <div id="search-results"></div>
    </div>

    <!-- Step 3: Function Tests -->
    <div class="section">
        <h2>Step 3: Netlify Function Tests</h2>
        <div>
            <button id="test-token-btn">Test Token Generation</button>
            <button id="test-search-btn">Test Search Function</button>
        </div>
        <div id="function-test-results"></div>
    </div>

    <!-- Debug Information -->
    <div class="section">
        <h2>Debug Information</h2>
        <button id="show-debug-btn">Show Debug Info</button>
        <pre id="debug-info" style="display: none;"></pre>
    </div>

    <script>
        // Configuration
        const SITE_URL = window.location.origin;
        const functions = {
            getToken: `${SITE_URL}/.netlify/functions/get-token`,
            search: `${SITE_URL}/.netlify/functions/apple-music-search`,
            addToLibrary: `${SITE_URL}/.netlify/functions/add-to-library`
        };

        // Global state
        let musicKit = null;
        let isAuthorized = false;
        let userToken = null;

        // DOM elements
        const authBtn = document.getElementById('authorize-btn');
        const unauthorizeBtn = document.getElementById('unauthorize-btn');
        const authStatus = document.getElementById('auth-status');
        const searchInput = document.getElementById('search-input');
        const searchType = document.getElementById('search-type');
        const searchBtn = document.getElementById('search-btn');
        const searchStatus = document.getElementById('search-status');
        const searchResults = document.getElementById('search-results');
        const testTokenBtn = document.getElementById('test-token-btn');
        const testSearchBtn = document.getElementById('test-search-btn');
        const functionTestResults = document.getElementById('function-test-results');
        const showDebugBtn = document.getElementById('show-debug-btn');
        const debugInfo = document.getElementById('debug-info');

        // Initialize MusicKit
        async function initializeMusicKit() {
            try {
                // Get developer token from our Netlify function
                const tokenResponse = await fetch(functions.getToken);
                if (!tokenResponse.ok) {
                    throw new Error(`Failed to get developer token: ${tokenResponse.status}`);
                }
                const tokenData = await tokenResponse.json();
                const developerToken = tokenData.token;

                // Configure MusicKit
                await window.MusicKit.configure({
                    developerToken: developerToken,
                    app: {
                        name: 'Apple Music Test App',
                        build: '1.0.0'
                    }
                });

                musicKit = window.MusicKit.getInstance();
                
                // Check if user is already authorized
                if (musicKit.isAuthorized) {
                    handleAuthSuccess();
                }

                updateAuthStatus('MusicKit initialized successfully', 'success');
                
            } catch (error) {
                console.error('MusicKit initialization failed:', error);
                updateAuthStatus(`Initialization failed: ${error.message}`, 'error');
            }
        }

        // Authorization functions
        async function authorize() {
            try {
                userToken = await musicKit.authorize();
                handleAuthSuccess();
            } catch (error) {
                console.error('Authorization failed:', error);
                updateAuthStatus(`Authorization failed: ${error.message}`, 'error');
            }
        }

        function unauthorize() {
            musicKit.unauthorize();
            isAuthorized = false;
            userToken = null;
            authBtn.style.display = 'block';
            unauthorizeBtn.style.display = 'none';
            updateAuthStatus('Signed out successfully', 'info');
        }

        function handleAuthSuccess() {
            isAuthorized = true;
            userToken = musicKit.musicUserToken;
            authBtn.style.display = 'none';
            unauthorizeBtn.style.display = 'block';
            updateAuthStatus('‚úÖ Authorized! You can now search and add songs to your library.', 'success');
        }

        // Search functions
        async function searchAppleMusic() {
            const term = searchInput.value.trim();
            const types = searchType.value;
            
            if (!term) {
                updateSearchStatus('Please enter a search term', 'error');
                return;
            }

            updateSearchStatus('Searching...', 'info');
            searchResults.innerHTML = '';

            try {
                const url = `${functions.search}?term=${encodeURIComponent(term)}&types=${types}&limit=10`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Search failed: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success && data.results && data.results[types]) {
                    displaySearchResults(data.results[types], types);
                    updateSearchStatus(`Found ${data.results[types].length} result(s)`, 'success');
                } else {
                    updateSearchStatus('No results found', 'warning');
                }

            } catch (error) {
                console.error('Search error:', error);
                updateSearchStatus(`Search failed: ${error.message}`, 'error');
            }
        }

        function displaySearchResults(results, type) {
            results.forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-result';
                
                if (type === 'songs') {
                    div.innerHTML = `
                        <div class="song-info">
                            <img src="${item.attributes.artwork?.url.replace('{w}', '60').replace('{h}', '60') || ''}" 
                                 alt="Album artwork" class="song-artwork">
                            <div class="song-details">
                                <h4>${item.attributes.name}</h4>
                                <p>by ${item.attributes.artistName}</p>
                                <p>Album: ${item.attributes.albumName}</p>
                            </div>
                            <button class="add-button" onclick="addToLibrary('${item.id}', '${item.attributes.name}')">
                                Add to Library
                            </button>
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <div class="song-info">
                            <img src="${item.attributes.artwork?.url.replace('{w}', '60').replace('{h}', '60') || ''}" 
                                 alt="Artwork" class="song-artwork">
                            <div class="song-details">
                                <h4>${item.attributes.name}</h4>
                                <p>${item.attributes.artistName || item.attributes.description || ''}</p>
                            </div>
                        </div>
                    `;
                }
                
                searchResults.appendChild(div);
            });
        }

        // Add to library function
        async function addToLibrary(songId, songName) {
            if (!isAuthorized) {
                alert('Please authorize Apple Music first!');
                return;
            }

            try {
                const response = await fetch(functions.addToLibrary, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        songIds: [songId],
                        userToken: userToken
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert(`‚úÖ Successfully added "${songName}" to your library!`);
                } else {
                    alert(`‚ùå Failed to add "${songName}": ${result.error || 'Unknown error'}`);
                }

            } catch (error) {
                console.error('Add to library error:', error);
                alert(`‚ùå Failed to add "${songName}": ${error.message}`);
            }
        }

        // Test functions
        async function testTokenGeneration() {
            updateFunctionTestResults('Testing token generation...', 'info');
            
            try {
                const response = await fetch(functions.getToken);
                const data = await response.json();
                
                if (response.ok && data.token) {
                    updateFunctionTestResults('‚úÖ Token generation successful!', 'success');
                } else {
                    updateFunctionTestResults(`‚ùå Token generation failed: ${data.error}`, 'error');
                }
            } catch (error) {
                updateFunctionTestResults(`‚ùå Token generation failed: ${error.message}`, 'error');
            }
        }

        async function testSearchFunction() {
            updateFunctionTestResults('Testing search function...', 'info');
            
            try {
                const response = await fetch(`${functions.search}?term=test&types=songs&limit=1`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    updateFunctionTestResults('‚úÖ Search function successful!', 'success');
                } else {
                    updateFunctionTestResults(`‚ùå Search function failed: ${data.error}`, 'error');
                }
            } catch (error) {
                updateFunctionTestResults(`‚ùå Search function failed: ${error.message}`, 'error');
            }
        }

        // Debug functions
        function showDebugInfo() {
            const debug = {
                siteUrl: SITE_URL,
                functions: functions,
                musicKitLoaded: !!window.MusicKit,
                musicKitInstance: !!musicKit,
                isAuthorized: isAuthorized,
                userToken: userToken ? 'Present' : 'None',
                timestamp: new Date().toISOString()
            };
            
            debugInfo.textContent = JSON.stringify(debug, null, 2);
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        // Utility functions
        function updateAuthStatus(message, type) {
            authStatus.textContent = message;
            authStatus.className = `status ${type}`;
        }

        function updateSearchStatus(message, type) {
            searchStatus.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function updateFunctionTestResults(message, type) {
            functionTestResults.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Event listeners
        authBtn.addEventListener('click', authorize);
        unauthorizeBtn.addEventListener('click', unauthorize);
        searchBtn.addEventListener('click', searchAppleMusic);
        testTokenBtn.addEventListener('click', testTokenGeneration);
        testSearchBtn.addEventListener('click', testSearchFunction);
        showDebugBtn.addEventListener('click', showDebugInfo);

        // Allow Enter key in search input
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchAppleMusic();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeMusicKit);
    </script>
</body>
</html>